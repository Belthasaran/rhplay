name: Build

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup build tools (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3 libudev-dev

      - name: Setup build tools (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          xcode-select --install || echo "Xcode tools already installed"

      - name: Setup build tools (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          echo "Windows build tools are handled by electron-builder install-app-deps"
          echo "Node-gyp will use Visual Studio Build Tools automatically on Windows"

      - name: Install dependencies
        run: npm ci
        
      - name: Rebuild native modules for Electron (all platforms)
        run: |
          echo "Rebuilding native modules for Electron..."
          npm run rebuild:native || echo "Note: Some native modules may need electron-builder to rebuild"
        
      - name: Verify native module build (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          if [ -f "native-modules/serialport-nonblock/build/Release/serialport_nonblock.node" ]; then
            echo "✓ Native module built successfully"
            file native-modules/serialport-nonblock/build/Release/serialport_nonblock.node
          else
            echo "⚠ Warning: Native module not found"
            exit 1
          fi
          
      - name: Verify native module build (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          if (Test-Path "native-modules\serialport-nonblock\build\Release\serialport_nonblock.node") {
            Write-Host "✓ Native module built successfully"
            Get-Item "native-modules\serialport-nonblock\build\Release\serialport_nonblock.node"
          } else {
            Write-Host "⚠ Warning: Native module not found after initial build"
            Write-Host "This may be expected - electron-builder will rebuild during packaging"
          }

      - name: Build (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Build (Windows)
        if: matrix.os == 'windows-latest'
        run: npm run build:win

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}
          path: dist-builds/**
